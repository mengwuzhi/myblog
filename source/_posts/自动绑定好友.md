---
title: 自动绑定好友
date: 2019-08-06 01:58:20
categories:
tags: [时序图]
description: 自动绑定好友体系
---

最近接到了一个需求，需要在游戏中建立一个两级的邀请的体系，要求设计一个流程通过下载app、注册、登录一系列的操作自动建立好友关系。通过给邀请人提供一些优势条件，达到提高用户量的目的。

不废话，时序图如下，红色部分为增添的新内容：
![时序图](https://i.loli.net/2019/08/17/NcWYAiStmwGRJCH.png)

#### 具体流程：
1. 客户端提供分享按钮，复制包含邀请人uid的下载链接
2. 在app下载页面中增加AJAX语句, 访问参数包含邀请人的下载页面时，通过POST方法请求登录服，将ip和邀请人uid传递给登录服
3. 登录服在mysql中建立ip和邀请人的关系。
4. app注册新用户时检查ip地址将新用户和邀请人绑定。
5. 首次登录游戏服时向登录服发送POST请求查询玩家的邀请人信息，并在游戏服建立 [玩家-邀请人-邀请人的邀请人] 的关系，方便以后查询。

注意：此方法对于绑定的准确性并不是100%，对玩家的操作的顺序以及方式有所要求。比如，多次访问下载链接会在登录服建立多个[邀请人-ip]的关系，一个ip可能对应多个邀请人的情况，同一个机器再反复注册可能不会绑定到真正想要绑定的邀请人id上等等。需要采取一些机制来维护登录服建立的绑定关系，这里我采取的办法是使用定时任务定时清理没有被绑定的关系。